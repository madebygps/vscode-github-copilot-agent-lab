<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Soc Ops — Social Bingo</title>
    <link rel="stylesheet" th:href="@{/css/app.css}"/>
    <link rel="icon" type="image/png" th:href="@{/favicon.png}"/>
</head>
<body class="h-full">

<!-- ============================================================= -->
<!--  LOBBY — visible before a game starts                          -->
<!-- ============================================================= -->
<div id="lobbyView" class="flex flex-col items-center justify-center min-h-full p-6">
    <div class="text-center max-w-sm">
        <h1 class="text-5xl font-bold neon-text font-display mb-2 glitch" data-text="SOC OPS">SOC OPS</h1>
        <p class="text-xl text-cyan uppercase tracking-wider mb-8">// Social Bingo</p>

        <div class="bg-card rounded-lg p-6 neon-border mb-8">
            <h2 class="font-semibold text-cyan font-display uppercase tracking-wider mb-4">[ MISSION BRIEFING ]</h2>
            <ul class="text-left text-gray-500 text-sm space-y-4">
                <li class="flex items-start gap-2">
                    <span class="text-magenta">&#9658;</span>
                    <span>Locate targets matching the criteria</span>
                </li>
                <li class="flex items-start gap-2">
                    <span class="text-magenta">&#9658;</span>
                    <span>Tap grid cells to mark confirmed matches</span>
                </li>
                <li class="flex items-start gap-2">
                    <span class="text-magenta">&#9658;</span>
                    <span>Complete 5 in sequence to achieve BINGO</span>
                </li>
            </ul>
        </div>

        <button onclick="launchGame()"
                class="cyber-button w-full text-lg">
            &lt; INITIALIZE GAME /&gt;
        </button>

        <p class="text-xs text-gray-500 mt-4 font-display">SYSTEM v2.0 // READY</p>
    </div>
</div>

<!-- ============================================================= -->
<!--  ACTIVE GAME — board, header, optional bingo banner            -->
<!-- ============================================================= -->
<div id="activeView" class="flex flex-col min-h-full" style="display:none">

    <!-- top bar -->
    <header class="flex items-center justify-between p-3 bg-card border-b border-cyan">
        <button onclick="retreatToLobby()"
                class="text-cyan text-sm px-3 py-1.5 rounded border border-cyan transition-all hover-shadow-neon">
            &#8592; EXIT
        </button>
        <h1 class="font-bold text-cyan font-display tracking-wider neon-text">SOC OPS</h1>
        <div class="w-16"></div>
    </header>

    <!-- hint -->
    <p class="text-center text-gray-500 text-sm py-2 px-4 font-display uppercase tracking-wider">
        [ Tap to mark targets ]
    </p>

    <!-- bingo banner (hidden until victory) -->
    <div id="bingoBanner"
         class="neon-border-pink text-magenta text-center py-3 font-bold font-display uppercase tracking-wider animate-flicker"
         style="display:none">
        &#9889; BINGO ACHIEVED &#9889; MISSION COMPLETE
    </div>

    <!-- the 5×5 grid -->
    <div class="flex-1 flex items-center justify-center p-3">
        <div id="gridContainer"
             class="grid grid-cols-5 gap-2 w-full max-w-md mx-auto aspect-square">
            <!-- tiles injected by JS -->
        </div>
    </div>
</div>

<!-- ============================================================= -->
<!--  VICTORY MODAL — overlays the board                            -->
<!-- ============================================================= -->
<div id="victoryOverlay"
     class="fixed inset-0 bg-black\/50 flex items-center justify-center p-4 z-50"
     style="display:none">
    <div class="bg-card neon-border-pink rounded-xl p-6 max-w-xs w-full text-center shadow-neon animate-[bounce_0.5s_ease-out]">
        <div class="text-5xl mb-4 animate-flicker">&#9889;</div>
        <h2 class="text-3xl font-bold text-magenta neon-text-pink font-display mb-2 glitch" data-text="BINGO!">BINGO!</h2>
        <p class="text-cyan mb-6 font-display uppercase tracking-wider">// Line completed //</p>
        <button onclick="dismissVictoryModal()"
                class="cyber-button w-full">
            &lt; CONTINUE MISSION /&gt;
        </button>
    </div>
</div>

<!-- ============================================================= -->
<!--  Client-side game engine                                       -->
<!-- ============================================================= -->
<script>
(function () {
    "use strict";

    var SIDE = 5;
    var TOTAL_CELLS = SIDE * SIDE;
    var PERSIST_KEY = "socops-bingo-snapshot";

    /* ── state ────────────────────────────────────────────────── */
    var liveTiles   = [];
    var streakFound = null;
    var modalShown  = false;
    var currentPhase = "LOBBY";

    /* ── DOM refs ─────────────────────────────────────────────── */
    var lobbyDiv   = document.getElementById("lobbyView");
    var activeDiv  = document.getElementById("activeView");
    var gridDiv    = document.getElementById("gridContainer");
    var bannerDiv  = document.getElementById("bingoBanner");
    var overlayDiv = document.getElementById("victoryOverlay");

    /* ── phase switching ──────────────────────────────────────── */
    function showPhase(phase) {
        currentPhase = phase;
        lobbyDiv.style.display   = (phase === "LOBBY") ? "" : "none";
        activeDiv.style.display  = (phase !== "LOBBY") ? "" : "none";
        bannerDiv.style.display  = (streakFound)       ? "" : "none";
        overlayDiv.style.display = (modalShown)        ? "" : "none";
    }

    /* ── board rendering ──────────────────────────────────────── */
    function paintGrid() {
        gridDiv.innerHTML = "";
        var winIds = streakFound ? gatherStreakIds(streakFound) : {};

        for (var t = 0; t < liveTiles.length; t++) {
            var tile = liveTiles[t];
            var btn = document.createElement("button");

            var base = "cyber-square relative flex items-center justify-center p-1 text-center " +
                       "rounded transition-all duration-300 select-none min-h-[60px] text-xs leading-tight text-white";

            var state = "";
            if (tile.selected) {
                state = winIds[tile.id]
                    ? "cyber-square winning text-magenta"
                    : "cyber-square marked text-cyan";
            }

            var extra = tile.freeCell ? " font-bold text-sm text-cyan neon-text" : "";
            btn.className = base + " " + state + extra;

            if (tile.freeCell) { btn.disabled = true; }
            btn.setAttribute("aria-pressed", String(tile.selected));
            btn.setAttribute("aria-label", tile.freeCell ? "Free space" : tile.prompt);

            var labelSpan = document.createElement("span");
            labelSpan.className = "wrap-break-word hyphens-auto";
            labelSpan.textContent = tile.prompt;
            btn.appendChild(labelSpan);

            if (tile.selected && !tile.freeCell) {
                var tick = document.createElement("span");
                tick.className = "absolute top-0.5 right-0.5 text-cyan text-xs neon-text";
                tick.textContent = "\u2713";
                btn.appendChild(tick);
            }

            btn.addEventListener("click", (function (cid) {
                return function () { onTileTapped(cid); };
            })(tile.id));

            gridDiv.appendChild(btn);
        }
    }

    /* ── tile tap logic ───────────────────────────────────────── */
    function onTileTapped(cellId) {
        liveTiles = flipTile(liveTiles, cellId);

        if (!streakFound) {
            var detected = scanForStreak(liveTiles);
            if (detected) {
                streakFound = detected;
                currentPhase = "VICTORY";
                modalShown = true;
            }
        }
        persistSnapshot();
        paintGrid();
        bannerDiv.style.display  = streakFound ? "" : "none";
        overlayDiv.style.display = modalShown  ? "" : "none";
    }

    function flipTile(board, cellId) {
        return board.map(function (c) {
            if (c.id === cellId && !c.freeCell) {
                return { id: c.id, prompt: c.prompt, selected: !c.selected, freeCell: false };
            }
            return c;
        });
    }

    function scanForStreak(board) {
        var r, c, positions, i;
        for (r = 0; r < SIDE; r++) {
            positions = [];
            for (c = 0; c < SIDE; c++) { positions.push(r * SIDE + c); }
            if (lineComplete(board, positions)) {
                return { direction: "row", index: r, cellPositions: positions };
            }
        }
        for (c = 0; c < SIDE; c++) {
            positions = [];
            for (r = 0; r < SIDE; r++) { positions.push(r * SIDE + c); }
            if (lineComplete(board, positions)) {
                return { direction: "column", index: c, cellPositions: positions };
            }
        }
        positions = [];
        for (i = 0; i < SIDE; i++) { positions.push(i * SIDE + i); }
        if (lineComplete(board, positions)) {
            return { direction: "diagonal", index: 0, cellPositions: positions };
        }
        positions = [];
        for (i = 0; i < SIDE; i++) { positions.push(i * SIDE + (SIDE - 1 - i)); }
        if (lineComplete(board, positions)) {
            return { direction: "diagonal", index: 1, cellPositions: positions };
        }
        return null;
    }

    function lineComplete(board, positions) {
        for (var k = 0; k < positions.length; k++) {
            if (!board[positions[k]].selected) { return false; }
        }
        return true;
    }

    function gatherStreakIds(streak) {
        var lookup = {};
        for (var j = 0; j < streak.cellPositions.length; j++) {
            lookup[streak.cellPositions[j]] = true;
        }
        return lookup;
    }

    /* ── localStorage persistence ─────────────────────────────── */
    function persistSnapshot() {
        try {
            var blob = JSON.stringify({
                phase: currentPhase,
                tiles: liveTiles,
                streak: streakFound,
                modal: modalShown
            });
            localStorage.setItem(PERSIST_KEY, blob);
        } catch (_) { /* storage full or unavailable */ }
    }

    function restoreSnapshot() {
        try {
            var raw = localStorage.getItem(PERSIST_KEY);
            if (!raw) { return false; }
            var snap = JSON.parse(raw);
            if (!snap.tiles || snap.tiles.length !== TOTAL_CELLS) { return false; }
            liveTiles   = snap.tiles;
            streakFound = snap.streak || null;
            modalShown  = !!snap.modal;
            currentPhase = snap.phase || "ACTIVE";
            return currentPhase !== "LOBBY";
        } catch (_) { return false; }
    }

    /* ── public API ───────────────────────────────────────────── */
    window.launchGame = function () {
        fetch("/api/bingo/fresh-board")
            .then(function (resp) { return resp.json(); })
            .then(function (cells) {
                liveTiles   = cells;
                streakFound = null;
                modalShown  = false;
                currentPhase = "ACTIVE";
                persistSnapshot();
                paintGrid();
                showPhase("ACTIVE");
            });
    };

    window.retreatToLobby = function () {
        liveTiles   = [];
        streakFound = null;
        modalShown  = false;
        currentPhase = "LOBBY";
        persistSnapshot();
        showPhase("LOBBY");
    };

    window.dismissVictoryModal = function () {
        modalShown = false;
        overlayDiv.style.display = "none";
        persistSnapshot();
    };

    /* ── boot ─────────────────────────────────────────────────── */
    if (restoreSnapshot()) {
        paintGrid();
        showPhase(currentPhase);
    } else {
        showPhase("LOBBY");
    }
})();
</script>

</body>
</html>
