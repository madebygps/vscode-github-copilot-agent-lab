<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Soc Ops — Social Bingo</title>
    <link rel="stylesheet" th:href="@{/css/app.css}"/>
    <link rel="icon" type="image/png" th:href="@{/favicon.png}"/>
</head>
<body class="h-full">

<!-- ============================================================= -->
<!--  LOBBY — mode selection                                        -->
<!-- ============================================================= -->
<div id="lobbyView" class="flex flex-col items-center justify-center min-h-full p-6">
    <div class="text-center max-w-sm">
        <h1 class="text-5xl font-bold neon-text font-display mb-2 glitch" data-text="SOC OPS">SOC OPS</h1>
        <p class="text-xl text-cyan uppercase tracking-wider mb-8">// Social Bingo</p>

        <div class="bg-card rounded-lg p-6 neon-border mb-8">
            <h2 class="font-semibold text-cyan font-display uppercase tracking-wider mb-4">[ SELECT MODE ]</h2>
            <div class="space-y-4">
                <button onclick="launchGame()"
                        class="cyber-button w-full text-sm">
                    &lt; BINGO MODE /&gt;
                    <span class="block text-xs opacity-70 mt-1">5x5 grid &#8226; Get 5 in a row</span>
                </button>

                <button onclick="launchScavengerHunt()"
                        class="cyber-button w-full text-sm">
                    &lt; SCAVENGER HUNT /&gt;
                    <span class="block text-xs opacity-70 mt-1">Checklist &#8226; Complete all tasks</span>
                </button>
            </div>
        </div>

        <div class="bg-card rounded-lg p-4 border border-gray-200 mb-4">
            <h3 class="font-semibold text-cyan font-display uppercase tracking-wider mb-3 text-sm">[ BRIEFING ]</h3>
            <ul class="text-left text-gray-500 text-xs space-y-2">
                <li class="flex items-start gap-2">
                    <span class="text-magenta">&#9658;</span>
                    <span>Find targets matching criteria</span>
                </li>
                <li class="flex items-start gap-2">
                    <span class="text-magenta">&#9658;</span>
                    <span>Mark confirmed matches</span>
                </li>
            </ul>
        </div>

        <p class="text-xs text-gray-500 font-display">SYSTEM v2.0 // READY</p>
    </div>
</div>

<!-- ============================================================= -->
<!--  BINGO GAME — board, header, optional bingo banner             -->
<!-- ============================================================= -->
<div id="activeView" class="flex flex-col min-h-full" style="display:none">

    <header class="flex items-center justify-between p-3 bg-card border-b border-cyan">
        <button onclick="retreatToLobby()"
                class="text-cyan text-sm px-3 py-1.5 rounded border border-cyan transition-all hover-shadow-neon">
            &#8592; EXIT
        </button>
        <h1 class="font-bold text-cyan font-display tracking-wider neon-text">SOC OPS</h1>
        <div class="w-16"></div>
    </header>

    <p class="text-center text-gray-500 text-sm py-2 px-4 font-display uppercase tracking-wider">
        [ Tap to mark targets ]
    </p>

    <div id="bingoBanner"
         class="neon-border-pink text-magenta text-center py-3 font-bold font-display uppercase tracking-wider animate-flicker"
         style="display:none">
        &#9889; BINGO ACHIEVED &#9889; MISSION COMPLETE
    </div>

    <div class="flex-1 flex items-center justify-center p-3">
        <div id="gridContainer"
             class="grid grid-cols-5 gap-2 w-full max-w-md mx-auto aspect-square">
        </div>
    </div>
</div>

<!-- ============================================================= -->
<!--  SCAVENGER HUNT — checklist mode                               -->
<!-- ============================================================= -->
<div id="scavengerView" class="flex flex-col min-h-full" style="display:none">

    <header class="flex items-center justify-between p-3 bg-card border-b border-cyan">
        <button onclick="retreatToLobby()"
                class="text-cyan text-sm px-3 py-1.5 rounded border border-cyan transition-all hover-shadow-neon">
            &#8592; EXIT
        </button>
        <h1 class="font-bold text-cyan font-display tracking-wider neon-text">SCAVENGER HUNT</h1>
        <div class="w-16"></div>
    </header>

    <!-- Progress Bar -->
    <div class="p-4">
        <div class="flex items-center justify-between mb-2">
            <span class="text-cyan font-display text-sm">PROGRESS</span>
            <span id="scavengerProgress" class="text-magenta font-display text-sm">0 / 0</span>
        </div>
        <div class="h-3 bg-card rounded-lg overflow-hidden neon-border">
            <div id="scavengerBar"
                 class="h-full bg-accent transition-all duration-300"
                 style="width: 0%">
            </div>
        </div>
    </div>

    <!-- Quest List -->
    <div id="scavengerList" class="flex-1 overflow-y-auto p-4 space-y-2">
    </div>

    <!-- Completion Message -->
    <div id="scavengerComplete" class="p-4 bg-card border-t border-magenta" style="display:none">
        <div class="text-center">
            <span class="text-3xl mb-2 block">&#127881;</span>
            <p class="text-magenta font-display neon-text-pink">MISSION COMPLETE!</p>
        </div>
    </div>
</div>

<!-- ============================================================= -->
<!--  VICTORY MODAL                                                 -->
<!-- ============================================================= -->
<div id="victoryOverlay"
     class="fixed inset-0 bg-black\/50 flex items-center justify-center p-4 z-50"
     style="display:none">
    <div class="bg-card neon-border-pink rounded-xl p-6 max-w-xs w-full text-center shadow-neon animate-[bounce_0.5s_ease-out]">
        <div class="text-5xl mb-4 animate-flicker">&#9889;</div>
        <h2 class="text-3xl font-bold text-magenta neon-text-pink font-display mb-2 glitch" data-text="BINGO!">BINGO!</h2>
        <p class="text-cyan mb-6 font-display uppercase tracking-wider">// Line completed //</p>
        <button onclick="dismissVictoryModal()"
                class="cyber-button w-full">
            &lt; CONTINUE MISSION /&gt;
        </button>
    </div>
</div>

<!-- ============================================================= -->
<!--  Client-side game engine                                       -->
<!-- ============================================================= -->
<script>
(function () {
    "use strict";

    var SIDE = 5;
    var TOTAL_CELLS = SIDE * SIDE;
    var PERSIST_KEY = "socops-bingo-snapshot";

    /* ── state ────────────────────────────────────────────────── */
    var liveTiles     = [];
    var streakFound   = null;
    var modalShown    = false;
    var currentPhase  = "LOBBY";
    var scavengerItems = [];
    var scavengerDone  = {};

    /* ── DOM refs ─────────────────────────────────────────────── */
    var lobbyDiv      = document.getElementById("lobbyView");
    var activeDiv     = document.getElementById("activeView");
    var scavengerDiv  = document.getElementById("scavengerView");
    var gridDiv       = document.getElementById("gridContainer");
    var bannerDiv     = document.getElementById("bingoBanner");
    var overlayDiv    = document.getElementById("victoryOverlay");

    /* ── phase switching ──────────────────────────────────────── */
    function showPhase(phase) {
        currentPhase = phase;
        lobbyDiv.style.display      = (phase === "LOBBY")          ? "" : "none";
        activeDiv.style.display     = (phase === "ACTIVE" || phase === "VICTORY") ? "" : "none";
        scavengerDiv.style.display  = (phase === "SCAVENGER")      ? "" : "none";
        bannerDiv.style.display     = (streakFound)                ? "" : "none";
        overlayDiv.style.display    = (modalShown)                 ? "" : "none";
    }

    /* ── bingo board rendering ────────────────────────────────── */
    function paintGrid() {
        gridDiv.innerHTML = "";
        var winIds = streakFound ? gatherStreakIds(streakFound) : {};

        for (var t = 0; t < liveTiles.length; t++) {
            var tile = liveTiles[t];
            var btn = document.createElement("button");

            var base = "cyber-square relative flex items-center justify-center p-1 text-center " +
                       "rounded transition-all duration-300 select-none min-h-[60px] text-xs leading-tight text-white";

            var state = "";
            if (tile.selected) {
                state = winIds[tile.id]
                    ? "cyber-square winning text-magenta"
                    : "cyber-square marked text-cyan";
            }

            var extra = tile.freeCell ? " font-bold text-sm text-cyan neon-text" : "";
            btn.className = base + " " + state + extra;

            if (tile.freeCell) { btn.disabled = true; }
            btn.setAttribute("aria-pressed", String(tile.selected));
            btn.setAttribute("aria-label", tile.freeCell ? "Free space" : tile.prompt);

            var labelSpan = document.createElement("span");
            labelSpan.className = "wrap-break-word hyphens-auto";
            labelSpan.textContent = tile.prompt;
            btn.appendChild(labelSpan);

            if (tile.selected && !tile.freeCell) {
                var tick = document.createElement("span");
                tick.className = "absolute top-0.5 right-0.5 text-cyan text-xs neon-text";
                tick.textContent = "\u2713";
                btn.appendChild(tick);
            }

            btn.addEventListener("click", (function (cid) {
                return function () { onTileTapped(cid); };
            })(tile.id));

            gridDiv.appendChild(btn);
        }
    }

    /* ── bingo tile tap ───────────────────────────────────────── */
    function onTileTapped(cellId) {
        liveTiles = flipTile(liveTiles, cellId);
        if (!streakFound) {
            var detected = scanForStreak(liveTiles);
            if (detected) {
                streakFound = detected;
                currentPhase = "VICTORY";
                modalShown = true;
            }
        }
        persistSnapshot();
        paintGrid();
        bannerDiv.style.display  = streakFound ? "" : "none";
        overlayDiv.style.display = modalShown  ? "" : "none";
    }

    function flipTile(board, cellId) {
        return board.map(function (c) {
            if (c.id === cellId && !c.freeCell) {
                return { id: c.id, prompt: c.prompt, selected: !c.selected, freeCell: false };
            }
            return c;
        });
    }

    function scanForStreak(board) {
        var r, c, positions, i;
        for (r = 0; r < SIDE; r++) {
            positions = [];
            for (c = 0; c < SIDE; c++) { positions.push(r * SIDE + c); }
            if (lineComplete(board, positions)) return { direction: "row", index: r, cellPositions: positions };
        }
        for (c = 0; c < SIDE; c++) {
            positions = [];
            for (r = 0; r < SIDE; r++) { positions.push(r * SIDE + c); }
            if (lineComplete(board, positions)) return { direction: "column", index: c, cellPositions: positions };
        }
        positions = [];
        for (i = 0; i < SIDE; i++) { positions.push(i * SIDE + i); }
        if (lineComplete(board, positions)) return { direction: "diagonal", index: 0, cellPositions: positions };
        positions = [];
        for (i = 0; i < SIDE; i++) { positions.push(i * SIDE + (SIDE - 1 - i)); }
        if (lineComplete(board, positions)) return { direction: "diagonal", index: 1, cellPositions: positions };
        return null;
    }

    function lineComplete(board, positions) {
        for (var k = 0; k < positions.length; k++) {
            if (!board[positions[k]].selected) return false;
        }
        return true;
    }

    function gatherStreakIds(streak) {
        var lookup = {};
        for (var j = 0; j < streak.cellPositions.length; j++) {
            lookup[streak.cellPositions[j]] = true;
        }
        return lookup;
    }

    /* ── scavenger hunt rendering ─────────────────────────────── */
    function paintScavengerList() {
        var listDiv = document.getElementById("scavengerList");
        listDiv.innerHTML = "";

        for (var i = 0; i < scavengerItems.length; i++) {
            var item = scavengerItems[i];
            var completed = !!scavengerDone[item.id];

            var btn = document.createElement("button");
            btn.className = "w-full flex items-center gap-3 p-3 bg-card rounded-lg border " +
                (completed ? "border-cyan neon-border" : "border-gray-200") +
                " transition-all";

            var checkbox = document.createElement("div");
            checkbox.className = "w-6 h-6 rounded border-2 " +
                (completed ? "border-cyan bg-accent" : "border-gray-500") +
                " flex items-center justify-center transition-all";
            if (completed) {
                var checkmark = document.createElement("span");
                checkmark.className = "text-white font-bold text-xs";
                checkmark.textContent = "\u2713";
                checkbox.appendChild(checkmark);
            }

            var label = document.createElement("span");
            label.className = "flex-1 text-left " +
                (completed ? "text-cyan line-through opacity-70" : "text-white");
            label.textContent = item.text;

            btn.appendChild(checkbox);
            btn.appendChild(label);

            btn.addEventListener("click", (function (itemId) {
                return function () { toggleScavengerItem(itemId); };
            })(item.id));

            listDiv.appendChild(btn);
        }

        updateScavengerProgress();
    }

    function toggleScavengerItem(itemId) {
        scavengerDone[itemId] = !scavengerDone[itemId];
        persistSnapshot();
        paintScavengerList();
    }

    function updateScavengerProgress() {
        var total = scavengerItems.length;
        var done = Object.keys(scavengerDone).filter(function (k) { return scavengerDone[k]; }).length;
        var pct = total > 0 ? (done * 100 / total) : 0;

        document.getElementById("scavengerProgress").textContent = done + " / " + total;
        document.getElementById("scavengerBar").style.width = pct + "%";
        document.getElementById("scavengerComplete").style.display = (done === total && total > 0) ? "" : "none";
    }

    /* ── localStorage persistence ─────────────────────────────── */
    function persistSnapshot() {
        try {
            var blob = JSON.stringify({
                phase: currentPhase,
                tiles: liveTiles,
                streak: streakFound,
                modal: modalShown,
                scavengerItems: scavengerItems,
                scavengerDone: scavengerDone
            });
            localStorage.setItem(PERSIST_KEY, blob);
        } catch (_) {}
    }

    function restoreSnapshot() {
        try {
            var raw = localStorage.getItem(PERSIST_KEY);
            if (!raw) return false;
            var snap = JSON.parse(raw);
            currentPhase = snap.phase || "LOBBY";
            if (currentPhase === "LOBBY") return false;

            liveTiles      = snap.tiles || [];
            streakFound    = snap.streak || null;
            modalShown     = !!snap.modal;
            scavengerItems = snap.scavengerItems || [];
            scavengerDone  = snap.scavengerDone || {};
            return true;
        } catch (_) { return false; }
    }

    /* ── public API ───────────────────────────────────────────── */
    window.launchGame = function () {
        fetch("/api/bingo/fresh-board")
            .then(function (resp) { return resp.json(); })
            .then(function (cells) {
                liveTiles   = cells;
                streakFound = null;
                modalShown  = false;
                scavengerItems = [];
                scavengerDone  = {};
                currentPhase = "ACTIVE";
                persistSnapshot();
                paintGrid();
                showPhase("ACTIVE");
            });
    };

    window.launchScavengerHunt = function () {
        fetch("/api/scavenger/items")
            .then(function (resp) { return resp.json(); })
            .then(function (items) {
                scavengerItems = items;
                scavengerDone  = {};
                liveTiles      = [];
                streakFound    = null;
                modalShown     = false;
                currentPhase   = "SCAVENGER";
                persistSnapshot();
                paintScavengerList();
                showPhase("SCAVENGER");
            });
    };

    window.retreatToLobby = function () {
        liveTiles      = [];
        streakFound    = null;
        modalShown     = false;
        scavengerItems = [];
        scavengerDone  = {};
        currentPhase   = "LOBBY";
        persistSnapshot();
        showPhase("LOBBY");
    };

    window.dismissVictoryModal = function () {
        modalShown = false;
        overlayDiv.style.display = "none";
        persistSnapshot();
    };

    /* ── boot ─────────────────────────────────────────────────── */
    if (restoreSnapshot()) {
        if (currentPhase === "SCAVENGER") {
            paintScavengerList();
        } else {
            paintGrid();
        }
        showPhase(currentPhase);
    } else {
        showPhase("LOBBY");
    }
})();
</script>

</body>
</html>
