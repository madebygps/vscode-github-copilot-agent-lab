<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Soc Ops — Social Bingo</title>
    <link rel="stylesheet" th:href="@{/css/app.css}"/>
    <link rel="icon" type="image/png" th:href="@{/favicon.png}"/>
</head>
<body class="h-full">

<!-- ============================================================= -->
<!--  LOBBY — mode selection                                        -->
<!-- ============================================================= -->
<div id="lobbyView" class="flex flex-col items-center justify-center min-h-full p-6">
    <div class="text-center max-w-sm">
        <h1 class="text-5xl font-bold neon-text font-display mb-2 glitch" data-text="SOC OPS">SOC OPS</h1>
        <p class="text-xl text-cyan uppercase tracking-wider mb-8">// Social Bingo</p>

        <div class="bg-card rounded-lg p-6 neon-border mb-8">
            <h2 class="font-semibold text-cyan font-display uppercase tracking-wider mb-4">[ SELECT MODE ]</h2>
            <div class="space-y-3">
                <button onclick="launchGame()"
                        class="cyber-button w-full text-sm">
                    &lt; BINGO /&gt;
                    <span class="block text-xs opacity-70 mt-1">5x5 grid &#8226; Get 5 in a row</span>
                </button>

                <button onclick="launchScavengerHunt()"
                        class="cyber-button w-full text-sm">
                    &lt; SCAVENGER HUNT /&gt;
                    <span class="block text-xs opacity-70 mt-1">Checklist &#8226; Complete all tasks</span>
                </button>

                <button onclick="launchCardDeck()"
                        class="cyber-button w-full text-sm">
                    &lt; CARD DECK /&gt;
                    <span class="block text-xs opacity-70 mt-1">Random cards &#8226; Swipe to match</span>
                </button>
            </div>
        </div>

        <p class="text-xs text-gray-500 font-display">SYSTEM v3.0 // READY</p>
    </div>
</div>

<!-- ============================================================= -->
<!--  BINGO GAME                                                    -->
<!-- ============================================================= -->
<div id="activeView" class="flex flex-col min-h-full" style="display:none">

    <header class="flex items-center justify-between p-3 bg-card border-b border-cyan">
        <button onclick="retreatToLobby()"
                class="text-cyan text-sm px-3 py-1.5 rounded border border-cyan transition-all hover-shadow-neon">
            &#8592; EXIT
        </button>
        <h1 class="font-bold text-cyan font-display tracking-wider neon-text">SOC OPS</h1>
        <div class="w-16"></div>
    </header>

    <p class="text-center text-gray-500 text-sm py-2 px-4 font-display uppercase tracking-wider">
        [ Tap to mark targets ]
    </p>

    <div id="bingoBanner"
         class="neon-border-pink text-magenta text-center py-3 font-bold font-display uppercase tracking-wider animate-flicker"
         style="display:none">
        &#9889; BINGO ACHIEVED &#9889; MISSION COMPLETE
    </div>

    <div class="flex-1 flex items-center justify-center p-3">
        <div id="gridContainer"
             class="grid grid-cols-5 gap-2 w-full max-w-md mx-auto aspect-square">
        </div>
    </div>
</div>

<!-- ============================================================= -->
<!--  SCAVENGER HUNT                                                -->
<!-- ============================================================= -->
<div id="scavengerView" class="flex flex-col min-h-full" style="display:none">

    <header class="flex items-center justify-between p-3 bg-card border-b border-cyan">
        <button onclick="retreatToLobby()"
                class="text-cyan text-sm px-3 py-1.5 rounded border border-cyan transition-all hover-shadow-neon">
            &#8592; EXIT
        </button>
        <h1 class="font-bold text-cyan font-display tracking-wider neon-text">SCAVENGER HUNT</h1>
        <div class="w-16"></div>
    </header>

    <div class="p-4">
        <div class="flex items-center justify-between mb-2">
            <span class="text-cyan font-display text-sm">PROGRESS</span>
            <span id="scavengerProgress" class="text-magenta font-display text-sm">0 / 0</span>
        </div>
        <div class="h-3 bg-card rounded-lg overflow-hidden neon-border">
            <div id="scavengerBar"
                 class="h-full bg-accent transition-all duration-300"
                 style="width: 0%">
            </div>
        </div>
    </div>

    <div id="scavengerList" class="flex-1 overflow-y-auto p-4 space-y-2">
    </div>

    <div id="scavengerComplete" class="p-4 bg-card border-t border-magenta" style="display:none">
        <div class="text-center">
            <span class="text-3xl mb-2 block">&#127881;</span>
            <p class="text-magenta font-display neon-text-pink">MISSION COMPLETE!</p>
        </div>
    </div>
</div>

<!-- ============================================================= -->
<!--  CARD DECK                                                     -->
<!-- ============================================================= -->
<div id="cardDeckView" class="flex flex-col min-h-full" style="display:none">

    <header class="flex items-center justify-between p-3 bg-card border-b border-cyan">
        <button onclick="retreatToLobby()"
                class="text-cyan text-sm px-3 py-1.5 rounded border border-cyan transition-all hover-shadow-neon">
            &#8592; EXIT
        </button>
        <h1 class="font-bold text-cyan font-display tracking-wider neon-text">CARD DECK</h1>
        <button onclick="reshuffleDeck()"
                class="text-magenta text-sm px-3 py-1.5 rounded border border-magenta transition-all hover-shadow-neon">
            SHUFFLE
        </button>
    </header>

    <!-- Card Area -->
    <div class="flex-1 flex items-center justify-center p-6">
        <div class="w-full max-w-xs perspective-1000">
            <div id="cardFlip" class="card-flip" onclick="handleCardTap()">
                <div class="card-flip-inner">
                    <!-- Card Back -->
                    <div class="card-face card-back bg-card rounded-2xl neon-border p-8 flex flex-col items-center justify-center">
                        <div class="text-6xl mb-4">&#127924;</div>
                        <p class="text-cyan font-display uppercase tracking-wider text-lg">TAP TO REVEAL</p>
                    </div>
                    <!-- Card Front -->
                    <div class="card-face card-front bg-card rounded-2xl neon-border-pink p-8 flex flex-col items-center justify-center text-center">
                        <p id="cardQuestion" class="text-xl font-semibold text-white mb-6 leading-relaxed"></p>
                        <p class="text-sm text-gray-500 font-display uppercase">Find someone who...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Action Buttons -->
    <div id="cardActions" class="p-4 flex gap-4" style="display:none">
        <button onclick="handleCardResult(false)"
                class="flex-1 py-4 bg-card border border-magenta rounded-lg text-magenta font-display uppercase tracking-wider transition-all hover-shadow-neon">
            &#10007; NO MATCH
        </button>
        <button onclick="handleCardResult(true)"
                class="flex-1 py-4 bg-card border border-cyan rounded-lg text-cyan font-display uppercase tracking-wider transition-all hover-shadow-neon">
            &#10003; FOUND ONE
        </button>
    </div>

    <!-- Stats -->
    <div class="p-4 bg-card border-t border-cyan">
        <div class="flex justify-around text-center">
            <div>
                <div id="cardMatches" class="text-2xl font-bold text-cyan neon-text">0</div>
                <div class="text-xs text-gray-500 font-display uppercase">Matches</div>
            </div>
            <div>
                <div id="cardSkipped" class="text-2xl font-bold text-magenta neon-text-pink">0</div>
                <div class="text-xs text-gray-500 font-display uppercase">Skipped</div>
            </div>
            <div>
                <div id="cardRemaining" class="text-2xl font-bold text-white">0</div>
                <div class="text-xs text-gray-500 font-display uppercase">Remaining</div>
            </div>
        </div>
    </div>
</div>

<!-- ============================================================= -->
<!--  VICTORY MODAL                                                 -->
<!-- ============================================================= -->
<div id="victoryOverlay"
     class="fixed inset-0 bg-black\/50 flex items-center justify-center p-4 z-50"
     style="display:none">
    <div class="bg-card neon-border-pink rounded-xl p-6 max-w-xs w-full text-center shadow-neon animate-[bounce_0.5s_ease-out]">
        <div class="text-5xl mb-4 animate-flicker">&#9889;</div>
        <h2 class="text-3xl font-bold text-magenta neon-text-pink font-display mb-2 glitch" data-text="BINGO!">BINGO!</h2>
        <p class="text-cyan mb-6 font-display uppercase tracking-wider">// Line completed //</p>
        <button onclick="dismissVictoryModal()"
                class="cyber-button w-full">
            &lt; CONTINUE MISSION /&gt;
        </button>
    </div>
</div>

<!-- ============================================================= -->
<!--  Client-side game engine                                       -->
<!-- ============================================================= -->
<script>
(function () {
    "use strict";

    var SIDE = 5;
    var TOTAL_CELLS = SIDE * SIDE;
    var PERSIST_KEY = "socops-bingo-snapshot";

    /* ── state ────────────────────────────────────────────────── */
    var liveTiles      = [];
    var streakFound    = null;
    var modalShown     = false;
    var currentPhase   = "LOBBY";
    var scavengerItems = [];
    var scavengerDone  = {};
    var cardDeck       = [];
    var cardIndex      = 0;
    var cardFlipped    = false;
    var cardMatches    = 0;
    var cardSkipped    = 0;

    /* ── DOM refs ─────────────────────────────────────────────── */
    var lobbyDiv      = document.getElementById("lobbyView");
    var activeDiv     = document.getElementById("activeView");
    var scavengerDiv  = document.getElementById("scavengerView");
    var cardDeckDiv   = document.getElementById("cardDeckView");
    var gridDiv       = document.getElementById("gridContainer");
    var bannerDiv     = document.getElementById("bingoBanner");
    var overlayDiv    = document.getElementById("victoryOverlay");

    /* ── phase switching ──────────────────────────────────────── */
    function showPhase(phase) {
        currentPhase = phase;
        lobbyDiv.style.display      = (phase === "LOBBY")                             ? "" : "none";
        activeDiv.style.display     = (phase === "ACTIVE" || phase === "VICTORY")      ? "" : "none";
        scavengerDiv.style.display  = (phase === "SCAVENGER")                          ? "" : "none";
        cardDeckDiv.style.display   = (phase === "CARDDECK")                           ? "" : "none";
        bannerDiv.style.display     = (streakFound)                                    ? "" : "none";
        overlayDiv.style.display    = (modalShown)                                     ? "" : "none";
    }

    /* ── bingo board ──────────────────────────────────────────── */
    function paintGrid() {
        gridDiv.innerHTML = "";
        var winIds = streakFound ? gatherStreakIds(streakFound) : {};
        for (var t = 0; t < liveTiles.length; t++) {
            var tile = liveTiles[t];
            var btn = document.createElement("button");
            var base = "cyber-square relative flex items-center justify-center p-1 text-center " +
                       "rounded transition-all duration-300 select-none min-h-[60px] text-xs leading-tight text-white";
            var state = "";
            if (tile.selected) {
                state = winIds[tile.id] ? "cyber-square winning text-magenta" : "cyber-square marked text-cyan";
            }
            var extra = tile.freeCell ? " font-bold text-sm text-cyan neon-text" : "";
            btn.className = base + " " + state + extra;
            if (tile.freeCell) btn.disabled = true;
            btn.setAttribute("aria-pressed", String(tile.selected));
            btn.setAttribute("aria-label", tile.freeCell ? "Free space" : tile.prompt);
            var labelSpan = document.createElement("span");
            labelSpan.className = "wrap-break-word hyphens-auto";
            labelSpan.textContent = tile.prompt;
            btn.appendChild(labelSpan);
            if (tile.selected && !tile.freeCell) {
                var tick = document.createElement("span");
                tick.className = "absolute top-0.5 right-0.5 text-cyan text-xs neon-text";
                tick.textContent = "\u2713";
                btn.appendChild(tick);
            }
            btn.addEventListener("click", (function (cid) {
                return function () { onTileTapped(cid); };
            })(tile.id));
            gridDiv.appendChild(btn);
        }
    }

    function onTileTapped(cellId) {
        liveTiles = flipTile(liveTiles, cellId);
        if (!streakFound) {
            var detected = scanForStreak(liveTiles);
            if (detected) {
                streakFound = detected;
                currentPhase = "VICTORY";
                modalShown = true;
            }
        }
        persistSnapshot();
        paintGrid();
        bannerDiv.style.display  = streakFound ? "" : "none";
        overlayDiv.style.display = modalShown  ? "" : "none";
    }

    function flipTile(board, cellId) {
        return board.map(function (c) {
            if (c.id === cellId && !c.freeCell) {
                return { id: c.id, prompt: c.prompt, selected: !c.selected, freeCell: false };
            }
            return c;
        });
    }

    function scanForStreak(board) {
        var r, c, positions, i;
        for (r = 0; r < SIDE; r++) {
            positions = [];
            for (c = 0; c < SIDE; c++) positions.push(r * SIDE + c);
            if (lineComplete(board, positions)) return { direction: "row", index: r, cellPositions: positions };
        }
        for (c = 0; c < SIDE; c++) {
            positions = [];
            for (r = 0; r < SIDE; r++) positions.push(r * SIDE + c);
            if (lineComplete(board, positions)) return { direction: "column", index: c, cellPositions: positions };
        }
        positions = [];
        for (i = 0; i < SIDE; i++) positions.push(i * SIDE + i);
        if (lineComplete(board, positions)) return { direction: "diagonal", index: 0, cellPositions: positions };
        positions = [];
        for (i = 0; i < SIDE; i++) positions.push(i * SIDE + (SIDE - 1 - i));
        if (lineComplete(board, positions)) return { direction: "diagonal", index: 1, cellPositions: positions };
        return null;
    }

    function lineComplete(board, positions) {
        for (var k = 0; k < positions.length; k++) {
            if (!board[positions[k]].selected) return false;
        }
        return true;
    }

    function gatherStreakIds(streak) {
        var lookup = {};
        for (var j = 0; j < streak.cellPositions.length; j++) lookup[streak.cellPositions[j]] = true;
        return lookup;
    }

    /* ── scavenger hunt ───────────────────────────────────────── */
    function paintScavengerList() {
        var listDiv = document.getElementById("scavengerList");
        listDiv.innerHTML = "";
        for (var i = 0; i < scavengerItems.length; i++) {
            var item = scavengerItems[i];
            var completed = !!scavengerDone[item.id];
            var btn = document.createElement("button");
            btn.className = "w-full flex items-center gap-3 p-3 bg-card rounded-lg border " +
                (completed ? "border-cyan neon-border" : "border-gray-200") + " transition-all";
            var checkbox = document.createElement("div");
            checkbox.className = "w-6 h-6 rounded border-2 " +
                (completed ? "border-cyan bg-accent" : "border-gray-500") +
                " flex items-center justify-center transition-all";
            if (completed) {
                var checkmark = document.createElement("span");
                checkmark.className = "text-white font-bold text-xs";
                checkmark.textContent = "\u2713";
                checkbox.appendChild(checkmark);
            }
            var label = document.createElement("span");
            label.className = "flex-1 text-left " + (completed ? "text-cyan line-through opacity-70" : "text-white");
            label.textContent = item.text;
            btn.appendChild(checkbox);
            btn.appendChild(label);
            btn.addEventListener("click", (function (itemId) {
                return function () { toggleScavengerItem(itemId); };
            })(item.id));
            listDiv.appendChild(btn);
        }
        updateScavengerProgress();
    }

    function toggleScavengerItem(itemId) {
        scavengerDone[itemId] = !scavengerDone[itemId];
        persistSnapshot();
        paintScavengerList();
    }

    function updateScavengerProgress() {
        var total = scavengerItems.length;
        var done = Object.keys(scavengerDone).filter(function (k) { return scavengerDone[k]; }).length;
        var pct = total > 0 ? (done * 100 / total) : 0;
        document.getElementById("scavengerProgress").textContent = done + " / " + total;
        document.getElementById("scavengerBar").style.width = pct + "%";
        document.getElementById("scavengerComplete").style.display = (done === total && total > 0) ? "" : "none";
    }

    /* ── card deck ────────────────────────────────────────────── */
    function updateCardDisplay() {
        var allDone = cardIndex >= cardDeck.length;
        var questionEl = document.getElementById("cardQuestion");
        var flipEl = document.getElementById("cardFlip");
        var actionsEl = document.getElementById("cardActions");

        questionEl.textContent = allDone ? "All done! \uD83C\uDF89" : cardDeck[cardIndex].text;
        flipEl.className = "card-flip" + (cardFlipped ? " flipped" : "");
        actionsEl.style.display = (cardFlipped && !allDone) ? "" : "none";

        document.getElementById("cardMatches").textContent = cardMatches;
        document.getElementById("cardSkipped").textContent = cardSkipped;
        document.getElementById("cardRemaining").textContent = Math.max(0, cardDeck.length - cardIndex);
    }

    window.handleCardTap = function () {
        if (!cardFlipped && cardIndex < cardDeck.length) {
            cardFlipped = true;
            persistSnapshot();
            updateCardDisplay();
        }
    };

    window.handleCardResult = function (isMatch) {
        if (isMatch) cardMatches++;
        else cardSkipped++;
        cardIndex++;
        cardFlipped = false;
        persistSnapshot();
        updateCardDisplay();
    };

    window.reshuffleDeck = function () {
        cardMatches = 0;
        cardSkipped = 0;
        cardIndex = 0;
        cardFlipped = false;
        // Simple Fisher-Yates shuffle
        for (var i = cardDeck.length - 1; i > 0; i--) {
            var j = Math.floor(Math.random() * (i + 1));
            var tmp = cardDeck[i];
            cardDeck[i] = cardDeck[j];
            cardDeck[j] = tmp;
        }
        persistSnapshot();
        updateCardDisplay();
    };

    /* ── localStorage persistence ─────────────────────────────── */
    function persistSnapshot() {
        try {
            localStorage.setItem(PERSIST_KEY, JSON.stringify({
                phase: currentPhase, tiles: liveTiles, streak: streakFound, modal: modalShown,
                scavengerItems: scavengerItems, scavengerDone: scavengerDone,
                cardDeck: cardDeck, cardIndex: cardIndex, cardFlipped: cardFlipped,
                cardMatches: cardMatches, cardSkipped: cardSkipped
            }));
        } catch (_) {}
    }

    function restoreSnapshot() {
        try {
            var raw = localStorage.getItem(PERSIST_KEY);
            if (!raw) return false;
            var snap = JSON.parse(raw);
            currentPhase   = snap.phase || "LOBBY";
            if (currentPhase === "LOBBY") return false;
            liveTiles      = snap.tiles || [];
            streakFound    = snap.streak || null;
            modalShown     = !!snap.modal;
            scavengerItems = snap.scavengerItems || [];
            scavengerDone  = snap.scavengerDone || {};
            cardDeck       = snap.cardDeck || [];
            cardIndex      = snap.cardIndex || 0;
            cardFlipped    = !!snap.cardFlipped;
            cardMatches    = snap.cardMatches || 0;
            cardSkipped    = snap.cardSkipped || 0;
            return true;
        } catch (_) { return false; }
    }

    /* ── public API ───────────────────────────────────────────── */
    window.launchGame = function () {
        fetch("/api/bingo/fresh-board")
            .then(function (r) { return r.json(); })
            .then(function (cells) {
                liveTiles = cells; streakFound = null; modalShown = false;
                scavengerItems = []; scavengerDone = {};
                cardDeck = []; cardIndex = 0; cardFlipped = false; cardMatches = 0; cardSkipped = 0;
                currentPhase = "ACTIVE";
                persistSnapshot(); paintGrid(); showPhase("ACTIVE");
            });
    };

    window.launchScavengerHunt = function () {
        fetch("/api/scavenger/items")
            .then(function (r) { return r.json(); })
            .then(function (items) {
                scavengerItems = items; scavengerDone = {};
                liveTiles = []; streakFound = null; modalShown = false;
                cardDeck = []; cardIndex = 0; cardFlipped = false; cardMatches = 0; cardSkipped = 0;
                currentPhase = "SCAVENGER";
                persistSnapshot(); paintScavengerList(); showPhase("SCAVENGER");
            });
    };

    window.launchCardDeck = function () {
        fetch("/api/cards/deck")
            .then(function (r) { return r.json(); })
            .then(function (cards) {
                cardDeck = cards; cardIndex = 0; cardFlipped = false; cardMatches = 0; cardSkipped = 0;
                liveTiles = []; streakFound = null; modalShown = false;
                scavengerItems = []; scavengerDone = {};
                currentPhase = "CARDDECK";
                persistSnapshot(); updateCardDisplay(); showPhase("CARDDECK");
            });
    };

    window.retreatToLobby = function () {
        liveTiles = []; streakFound = null; modalShown = false;
        scavengerItems = []; scavengerDone = {};
        cardDeck = []; cardIndex = 0; cardFlipped = false; cardMatches = 0; cardSkipped = 0;
        currentPhase = "LOBBY";
        persistSnapshot(); showPhase("LOBBY");
    };

    window.dismissVictoryModal = function () {
        modalShown = false;
        overlayDiv.style.display = "none";
        persistSnapshot();
    };

    /* ── boot ─────────────────────────────────────────────────── */
    if (restoreSnapshot()) {
        if (currentPhase === "SCAVENGER") paintScavengerList();
        else if (currentPhase === "CARDDECK") updateCardDisplay();
        else paintGrid();
        showPhase(currentPhase);
    } else {
        showPhase("LOBBY");
    }
})();
</script>

</body>
</html>
